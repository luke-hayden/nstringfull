---
title: "qual"
author: "Luke Hayden"
date: "July 26, 2018"
output: html_document
---



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
library(dplyr)
library(ggbiplot)
library(tibble)
library(tidyr)
library(reshape2)
library(matrixStats)
library(gtools)
library(GGally)
```




```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
#setwd("~/Documents/nstringjul18")
load(file="allns_data.rdata")

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


mc <- melt(ctall.norm/rowMeans(ctall.norm, na.rm=T))
colnames(mc) <- c("marker", "sample", "expression")
mc <- left_join(mc, sampleinfo, by= "sample") %>%
#  left_join(posdf, by= "sample") %>%
  mutate(ctgsamp= paste0(ctg,"  ",  sample, ": ", over10reads  ))



(p=ggplot(mc, aes(x=marker, y=expression, colour=over0reads)) +geom_point() +
  facet_wrap(~ctgsamp, ncol=6)+
    scale_y_log10()+
    scale_colour_gradient(high="green", low="red2")+
    theme_minimal()
  )
  
ggsave(plot=p, filename = "qual.pdf", device="pdf", height=40, width=6, limitsize = F)
  

````

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
hkdat <- as.data.frame(t(ctall.hk))

nhkdat <- t(ctall.hk/rowMeans(ctall.hk))

meds <- colMedians(t(ctall.hk))


hkdat$over1 <- rowSums(hkdat>0)
hkdat$over3 <- rowSums(t(ctall.hk)>3)

hkdat$over5 <- rowSums(t(ctall.hk)>5)


hkdat$over10 <- rowSums(t(ctall.hk)>10)

hkdat$sample <- rownames(hkdat)

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
save(hkdat, file="hkdat.rdata")

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


md <- as.data.frame(t(subset(t(ctall.norm), 
                 sampleinfo$prep == "Nikos" & 
                 sampleinfo$ctg %in% 3:4&
  !(sampleinfo$sample %in% c("O1a", "O1b", "YR1a", "YR1b" , "YR2a", "YR2b")))))


si <- subset(sampleinfo, sampleinfo$sample %in% colnames(md))


sl <- as.character(sampleinfo$sample[sampleinfo$sample %in% colnames(md)])

md$marker <- rownames(md)

mmd <- gather(as.data.frame(md), key="sample", value="expression", sl) 
mmd$gp <- substr(mmd$sample, 1, nchar(mmd$sample)-1)

mmd$rep <- substr(mmd$sample,  nchar(mmd$sample), nchar(mmd$sample))


md <- select(mmd, -sample) 


mmd2 <- left_join( select(dplyr::rename(filter(md, rep=="a"), expression_a =expression), -rep),
                   select(dplyr::rename(filter(md, rep=="b"), expression_b =expression), -rep),
                   by=c("marker", "gp") )


ggplot(mmd2, aes(x=expression_a, y=expression_b))+
  geom_point(alpha=0.1)+
  geom_smooth(method="lm")+
# geom_hex()+
  theme_bw()+
   scale_x_log10()+
  scale_y_log10()


ablm <- lm(expression_a~expression_b, data=mmd2)
summary(ablm)

mmd2$predexpa <- predict(ablm)
mmd2$resid <- mmd2$expression_a -mmd2$predexpa


mmd2$abfc <- foldchange2logratio(foldchange(mmd2$expression_a, mmd2$expression_b))
mmd2$absabfc <- abs(mmd2$abfc)
mmd2$normresid <- mmd2$resid/mmd2$expression_b

ggplot(mmd2, aes(y=normresid, x=expression_b))+
  geom_point(alpha=0.1)+
  stat_smooth()+
# geom_hex()+
  theme_bw()+
  scale_x_log10()




````




```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
mhk <- hkdat[, 1:5]
mhk <- mhk[ , order(names(mhk))]
cormat <- round(cor(mhk),2)


#cormat[lower.tri(cormat)] <- NA

mcm <- melt(cormat, na.rm = TRUE)
#mcm$vcomb<- paste0(mcm$Var1, mcm$Var2)
#mcm <- subset(mcm, duplicated(mcm$vcomb))



ggplot(data = mcm, aes(Var1, Var2, fill = value, label=value))+
 geom_tile(color = "white")+
    geom_text(colour="black")+
 scale_fill_gradient2(low = "red3", high = "cornflower blue", mid = "white", 
   midpoint = 0.5, limit = c(0,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
 coord_fixed()+
  xlab("")+
  ylab("")+
  ggtitle("Correlation between Housekeeping Genes")

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
ggpairs(mhk)+
  theme_bw()

```