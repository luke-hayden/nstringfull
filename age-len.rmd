---
title: "Modelling the relationship between age and body length"
author: "Luke Hayden"
date: "August 3, 2018"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


library(dplyr)
library(ggbiplot)
library(tibble)
library(tidyr)
library(caret)

library(gtools)



powerTransform <- function(y, lambda1, lambda2 = NULL, method = "boxcox") {

  boxcoxTrans <- function(x, lam1, lam2 = NULL) {

    # if we set lambda2 to zero, it becomes the one parameter transformation
    lam2 <- ifelse(is.null(lam2), 0, lam2)

    if (lam1 == 0L) {
      log(y + lam2)
    } else {
      (((y + lam2)^lam1) - 1) / lam1
    }
  }

  switch(method
         , boxcox = boxcoxTrans(y, lambda1, lambda2)
         , tukey = y^lambda1
  )
}
```



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

setwd("~/Documents/nstringjul18")
load(file="allns_data.rdata")
zklen <- read.csv("zk-age-len.csv")[2:3] %>%
  mutate(prep="ZK")

lena <- sampleinfo %>%
  filter(!is.na(wkage)) %>%
  select(length, wkage, prep) %>%
  rbind(zklen)


```

#Age-length relationship visualised

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}



ggplot(lena, aes(y=length, x=wkage))+
  geom_point()+
  geom_smooth()+
  theme_bw()+
  scale_colour_brewer(palette="Set1")+
  ggtitle("Age-length relationship in female Parhyale")+
  ylab("Body length (mm)")+
  xlab("Age (weeks)")
  
```

#Model length vs age

We will use the following models:

###Linear regression: age ~ length

Relevant metrics: 
RMSE (lower is better)
R^2 (higher is better)

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

lena$wkage <- as.numeric(lena$wkage)

lena$loglen <- log(lena$length)
lena$lensq <- (lena$length)^2



m <- lm(wkage~length, data=lena)
summary(m)

(bc <- MASS::boxcox(length~wkage, data=lena))

(lambda <- bc$x[which.max(bc$y)])



# re-run with transformation

lena$bctranslen <- powerTransform(lena$length, lambda)
mnew <- lm(wkage~bctranslen, data=lena )
summary(mnew)


lena$linpred <- predict(m)
lena$linresid <- lena$wkage -lena$linpred
lena$bcpred <- predict(mnew)
lena$bcresid <- lena$wkage -lena$bcpred



```

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

mlena <- gather(lena, key="model", value="pred", c("bcpred", "linpred"))


ggplot(mlena, aes(x=pred, y=length, colour=model))+
  geom_smooth(aes(y=length, x=wkage), colour="forest green")+
  geom_line(size=1.5) +
  theme_bw()+
  geom_point(aes(x=wkage), colour="black")+
  scale_colour_brewer(palette="Set1")+
  xlab("Age (weeks)")+
  ylab("Body length (mm)")+
  ggtitle(label= "Linear regression age vs length", 
          subtitle=paste0("linear model R-squared: ", round(summary(m)$r.squared, 3), 
                 "\nBox-cox transformed linear model R-squared: ", round(summary(mnew)$r.squared, 3)))#+ scale_colour_manual(values=c("cornflower blue", "red3"), name="Model", labels=c("Box-cox transformed", "Linear untransformed"))
  

```


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


mlena <- gather(lena, key="model", value="resid", c("bcresid", "linresid"))

ggplot(mlena, aes(y=resid, x=length, colour=model))+
  geom_point()+
  scale_colour_brewer(palette="Set1")+
  theme_bw()+
  facet_wrap(~model)
````


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

sampleinfo$predage <- NULL
preddf <-subset(sampleinfo, !is.na(sampleinfo$length))

preddf$bctranslen <- powerTransform(preddf$length, lambda)
preddf$predage <-  predict(mnew, newdata=preddf)


sampleinfo <- left_join(sampleinfo, dplyr::select(preddf, sample, predage), by="sample")


```




```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


save(sampleinfo,ctall.norm,ctallgood.norm, codeset,geneinf,ctall.unnorm, ctall.intonly , file="allns_data.rdata")


```

