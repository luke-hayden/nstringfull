---
title: "import"
author: "Luke Hayden"
date: "July 20, 2018"
output: html_document
---



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
library(NanoStringNorm)
library(dplyr)
library(ggbiplot)
library(tibble)
library(tidyr)
library(lubridate)
````




```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

setwd("~/Documents/nstringjul18/1011")
ct1011.raw <- read.markup.RCC()


setwd("~/Documents/nstringjul18/1213")
ct1213.raw <- read.markup.RCC()


setwd("~/Documents/nstringjul18/14")
ct14.raw <- read.markup.RCC()


setwd("~/Documents/nstringjul18/15")
ct15.raw <- read.markup.RCC()


````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

ctg1011.norm <- NanoStringNorm(x = ct1011.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg1213.norm <- NanoStringNorm(x = ct1213.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg14.norm <- NanoStringNorm(x = ct14.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg15.norm <- NanoStringNorm(x = ct15.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ct1015.norm <- rownames_to_column(as.data.frame(cbind(ctg1011.norm,ctg1213.norm, ctg14.norm)) )%>%
  left_join(rownames_to_column(as.data.frame(ctg15.norm)))

rownames(ct1015.norm) <- ct1015.norm$marker
ct1015.norm$rowname <- NULL
```

#Internal controls only
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


ctg1011.intonly <- NanoStringNorm(x = ct1011.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);



ctg1213.intonly <- NanoStringNorm(x = ct1213.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);


ctg14.intonly <- NanoStringNorm(x = ct14.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);


ctg15.intonly <- NanoStringNorm(x = ct15.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ct1015.intonly <- rownames_to_column(as.data.frame(cbind(ctg1011.intonly,ctg1213.intonly, ctg14.intonly)) )%>%
  left_join(rownames_to_column(as.data.frame(ctg15.intonly)))

rownames(ct1015.intonly) <- ct1015.intonly$marker
ct1015.intonly$rowname <- NULL


```


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


ctg1011.unnorm <- NanoStringNorm(x = ct1011.raw, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg1213.unnorm <- NanoStringNorm(x = ct1213.raw, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg14.unnorm <- NanoStringNorm(x = ct14.raw, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg15.unnorm <- NanoStringNorm(x = ct15.raw, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);


ct1015.unnorm <- rownames_to_column(as.data.frame(cbind(ctg1011.unnorm,ctg1213.unnorm, ctg14.unnorm)) )%>%
  left_join(rownames_to_column(as.data.frame(ctg15.unnorm)))

rownames(ct1015.unnorm) <- ct1015.unnorm$marker
ct1015.unnorm$rowname <- NULL
```





```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}



setwd("~/nstringn17/ctg5and6")
ct5and6.raw <- read.markup.RCC()


setwd("~/nstringn17/ctg5hi")
ct5and6hi.raw <- read.markup.RCC()
 
setwd("~/nstringn17/ctg7and8")
ct7and8.raw <- read.markup.RCC()


# setwd("~/nstringn17/ctg7and8hi")
# ct7and8hi.raw <- read.markup.RCC()

setwd("~/nstringn17/ctg3and4")

ct3and4.raw <- read.markup.RCC()

# 
# setwd("~/nstringn17/ctg1and2")
# 
# ct1and2.raw <- read.markup.RCC()
# 
# 
# setwd("~/nstringn17/ctg9")
# 
# ct9.raw <- read.markup.RCC()
# 




```



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}



t <- ct1011.raw
t$x$CodeClass <- "Endogenous"
ctg1011.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
hknames <- rownames(ctg1011.matr)[210:214]
ctg1011.hk <- subset(ctg1011.matr, rownames(ctg1011.matr) %in% hknames)


t <- ct1213.raw
t$x$CodeClass <- "Endogenous"
ctg1213.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
ctg1213.hk <- subset(ctg1213.matr, rownames(ctg1213.matr) %in% hknames)

t <- ct14.raw
t$x$CodeClass <- "Endogenous"
ctg14.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
ctg14.hk <- subset(ctg14.matr, rownames(ctg14.matr) %in% hknames)

t <- ct15.raw
t$x$CodeClass <- "Endogenous"
ctg15.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
ctg15.hk <- subset(ctg15.matr, rownames(ctg15.matr) %in% hknames)


t <- ct1and2.raw
t$x$CodeClass <- "Endogenous"
ctg1and2.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
ctg1and2.hk <- subset(ctg1and2.matr, rownames(ctg1and2.matr) %in% hknames)

t <- ct3and4.raw
t$x$CodeClass <- "Endogenous"
ctg3and4.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
ctg3and4.hk <- subset(ctg3and4.matr, rownames(ctg3and4.matr) %in% hknames)

t <- ct5and6hi.raw
t$x$CodeClass <- "Endogenous"
ctg5and6hi.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
ctg5and6hi.hk <- subset(ctg5and6hi.matr, rownames(ctg5and6hi.matr) %in% hknames)

t <- ct7and8hi.raw
t$x$CodeClass <- "Endogenous"
ctg7and8hi.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
ctg7and8hi.hk <- subset(ctg7and8hi.matr, rownames(ctg7and8hi.matr) %in% hknames)

t <- ct9.raw
t$x$CodeClass <- "Endogenous"
ctg9.matr <- NanoStringNorm(x = t, anno = NA, CodeCount ='none', Background ="none",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);
ctg9.hk <- subset(ctg9.matr, rownames(ctg9.matr) %in% hknames)


````


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


load(file="nov17main_data.rdata")
load(file="markerchoiceinfo.rdata")

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


ctall.norm <- cbind(ctg1to9, as.matrix(ct1015.norm))

ctall.unnorm <- cbind(ctg1to9un, as.matrix(ct1015.unnorm))

ctall.intonly <- cbind(ctg1to9intonly, as.matrix(ct1015.intonly))



sampleinfo <- read.csv("siall.csv")
colnames(ctall.norm) <- sampleinfo$sample

colnames(ctall.unnorm) <- sampleinfo$sample

colnames(ctall.intonly) <- sampleinfo$sample

  
  
log <-rownames(ctall.norm) %in% minf$name[minf$chosenand ==T]

ctallgood.norm <- as.matrix(subset(ctall.norm, log))
  


#dates <- sampleinfo$cohdate[sampleinfo$cohdate != ""]
sampleinfo$cohdate <- parse_date_time(sampleinfo$cohdate,c('dmy'))
sampleinfo$wkage <- difftime( parse_date_time("07/07/18",c('dmy')), sampleinfo$cohdate, units=c("weeks"))

````










```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
sampleinfo <- mutate(sampleinfo, key= paste(sample, ctg))


posdf <-data.frame( over0reads =  as.numeric(colSums(ctall.norm >0, na.rm=T)),
                    over10reads =  as.numeric(colSums(ctall.norm >10, na.rm=T)), 
                   key= sampleinfo$key  )


sampleinfo <- left_join(sampleinfo, posdf, by= "key")




save(sampleinfo,ctall.norm,ctallgood.norm, codeset,geneinf,ctall.unnorm, ctall.intonly , file="allns_data.rdata")


````






```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}



log <- sampleinfo$reg == "" & 
  !(sampleinfo$age %in% c("N")) & 
  sampleinfo$sex == "F"&
  sampleinfo$exp %in% c("OvY", "Size-age") & 
  !(sampleinfo$sample %in% c("T","C", "U", "LFPD", "O1a", "SFPA", "LFIB","LFIA","AF", "Coh8")) &
#  sampleinfo$over10reads > 100 &
  sampleinfo$ctg > 2 &
  sampleinfo$prep == "Luke"

bcmin <- as.matrix(ctallgood.norm[,log== TRUE])
bcmin.groups <- subset(sampleinfo$type, log==TRUE)

tbc <- as.matrix(t(bcmin))

bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups


ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=F, labels=rownames(tbc), groups=bc.groups)+ggtitle("PCA of Old vs Young (females)")+
    theme_minimal() +
#  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))+
#  geom_label(label=rownames(tbc), aes(colour=bc.groups))+
  scale_colour_manual(values= c("darkviolet","cornflower blue",  "red2"))


````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}



log <- sampleinfo$reg == "" & 
  !(sampleinfo$age %in% c("N")) & 
  sampleinfo$sex == "F"&
  sampleinfo$exp %in% c("OvY", "Size-age", "cohorts") & 
  !(sampleinfo$sample %in% c("T","C", "U", "LFPD", "O1a", "SFPA", "LFIB", "LFIA", "LFIB", "LFIC", "LFID")) &
#  sampleinfo$over10reads > 100 &
  sampleinfo$ctg > 2 &
  sampleinfo$ctg <10 &
  sampleinfo$prep == "Luke"

bcmin <- as.matrix(ctallgood.norm[,log== TRUE])
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
tbc <- as.matrix(t(bcmin))
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups


ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=F, labels=rownames(tbc), groups=bc.groups)+ggtitle("PCA of Old vs Young (females)")+
    theme_minimal() +
#  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))+
#  geom_label(label=rownames(tbc), aes(colour=bc.groups))+
  scale_colour_manual(values= c("darkviolet","cornflower blue",  "red2"))

log <- sampleinfo$reg == "" & 
  !(sampleinfo$age %in% c("N", "M")) & 
  sampleinfo$sex == "F"&
  sampleinfo$exp %in% c("OvY", "Size-age") & 
  !(sampleinfo$sample %in% c("T","C", "U", "LFPD", "O1a", "SFPA", "LFIB")) &
  sampleinfo$over10reads >90 &
  sampleinfo$ctg > 2 &
  sampleinfo$ctg >9 &
  sampleinfo$prep == "Luke"


rg <-as.matrix(ctallgood.norm[,log== TRUE])

rg.groups <- sampleinfo$type[sampleinfo$sample %in% colnames(rg)]

rg.sc <- scale(t(rg), center= bc.pca$center)
rg.pred <- rg.sc %*% bc.pca$rotation 


rgd.pca <- bc.pca
rgd.pca$x <- rbind(bc.pca$x, rg.pred)
                   
                   
rgd.groups <- c(paste(as.character(bcmin.groups), "(old)"), paste(as.character(rg.groups), "(new)" )    )           

ggbiplot(rgd.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = F, var.axes=FALSE, labels=rownames(rgd.pca$x), groups=rgd.groups, varname.abbrev = TRUE)+   
  theme_bw() +
  theme(legend.direction = 'horizontal', legend.position = 'top')+
  ggtitle("PCA Old vs Young + regenerated projected")








````






```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````
