---
title: "qual"
author: "Luke Hayden"
date: "July 26, 2018"
output: html_document
---



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
library(dplyr)
library(ggbiplot)
library(tibble)
library(tidyr)
library(reshape2)
library(matrixStats)
````




```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
setwd("~/Documents/nstringjul18")
load(file="allns_data.rdata")

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


mc <- melt(ctall.norm/rowMeans(ctall.norm, na.rm=T))
colnames(mc) <- c("marker", "sample", "expression")
mc <- left_join(mc, sampleinfo, by= "sample") %>%
#  left_join(posdf, by= "sample") %>%
  mutate(ctgsamp= paste0(ctg,"  ",  sample, ": ", over10reads  ))



(p=ggplot(mc, aes(x=marker, y=expression, colour=over0reads)) +geom_point() +
  facet_wrap(~ctgsamp, ncol=6)+
    scale_y_log10()+
    scale_colour_gradient(high="green", low="red2")+
    theme_minimal()
  )
  
ggsave(plot=p, filename = "qual.pdf", device="pdf", height=40, width=6, limitsize = F)
  

````

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
hkdat <- as.data.frame(t(ctall.hk))

nhkdat <- t(ctall.hk/rowMeans(ctall.hk))

meds <- colMedians(t(ctall.hk))


hkdat$over1 <- rowSums(hkdat>0)
hkdat$over3 <- rowSums(t(ctall.hk)>3)

hkdat$over5 <- rowSums(t(ctall.hk)>5)


hkdat$over10 <- rowSums(t(ctall.hk)>10)

hkdat$sample <- rownames(hkdat)

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
save(hkdat, file="hkdat.rdata")

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


md <- as.data.frame(t(subset(t(ctall.norm), 
                 sampleinfo$prep == "Nikos" & 
                 sampleinfo$ctg %in% 3:4&
  !(sampleinfo$sample %in% c("O1a", "O1b", "YR1a", "YR1b" , "YR2a", "YR2b")))))


si <- subset(sampleinfo, sampleinfo$sample %in% colnames(md))


sl <- as.character(sampleinfo$sample[sampleinfo$sample %in% colnames(md)])

md$marker <- rownames(md)

mmd <- gather(as.data.frame(md), key="sample", value="expression", sl) 
mmd$gp <- substr(mmd$sample, 1, nchar(mmd$sample)-1)

mmd$rep <- substr(mmd$sample,  nchar(mmd$sample), nchar(mmd$sample))


md <- select(mmd, -sample)

md2 <- select(md, rfagepred, group, ty) %>%
  spread(value=rfagepred,key=ty) %>%
  left_join(mdhk, by= "group")


````
