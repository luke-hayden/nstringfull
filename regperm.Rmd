---
title: "regperm"
output: html_document
---




```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
library(dplyr)
library(ggbiplot)
library(tibble)
library(tidyr)
library(caret)
library(RColorBrewer)
library(ggrepel)
library(gtools)
library(FinCal)
library(ggrepel)
library(reshape2)



 rep.row<-function(x,n){
   matrix(rep(x,each=n),nrow=n)
 } 

#library(e10)
````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
#setwd("~/Documents/nstringjul18/nstringfull")
load(file="allns_data.rdata")
load(file="modelrf.rdata")
load(file="modelgbm.rdata")
load(file="hkdat.rdata")
load(file="sampleinfo.rdata")
load(file="goodgroups.rdata")


````


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


md <- as.data.frame(subset(t(ctall.norm), 
                           (sampleinfo$sex == "F" &
                 sampleinfo$exp %in% c("regen") & 
                  sampleinfo$ctg > 5 &
                   substr(sampleinfo$sample,1,1) %in% goodgroups &
                 sampleinfo$type %in% c("O", "Y", "M", "OR", "MR", "YR")
 )))

mymodel <- currbestgbm

#mymodel <- rfagemodel61
md <- md[, colnames(md) %in% mymodel$coefnames]

regs <- subset(md, substr(rownames(md),2,4) == "reg")
uns <- subset(md, substr(rownames(md),2,3) == "un")

reguns <- rbind(regs, uns)

r <- nrow(regs)
c <- ncol(regs)


 
 
mreguns <- melt(rownames_to_column(reguns))

colnames(mreguns) <- c("sample", "marker", "exp")
````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
nperm <- 500

mm3<- data.frame(matrix(ncol = 4, nrow = 0))
colnames(mm3) <- c( "group" , "marker" ,"choice" ,"perm" )
for (i in 1:ncol(reguns)){

#for (i in 1:3){
  
cm <- colnames(reguns)[i]



mm2<- data.frame(matrix(ncol = 4, nrow = 0))
colnames(mm2) <- c( "group" , "marker" ,"choice" ,"perm" )
for (j in 1:nperm){

m1 <- as.data.frame(round(matrix(runif(r*c), r, c)))


choices <-sample(c("reg", "un"), size=ncol(regs), replace=TRUE)
 
m1 <- as.data.frame(rep.row(choices,r))

colnames(m1) <- colnames(regs)
m1$group <- substr(rownames(regs),1,1)



mm1 <- gather(m1, key= marker, value="choice", -group)
mm1$perm <- j
mm2 <- rbind(mm2,mm1)

}


mm2$choice[mm2$marker == cm] <- "reg"
mm2$sample <- paste0(mm2$group, mm2$choice)

mm2$cm <- cm


mm3 <- rbind(mm2, mm3)

}

mm3 <- left_join(mm3, mreguns, by=c("sample", "marker"))


sm3 <- spread(select(mm3,-sample, -choice), value="exp", key="marker")

sm3$predage <- predict(mymodel, newdata= sm3[,colnames(sm3)%in% colnames(reguns)])

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
reguns2 <-mutate(reguns, predage= predict(mymodel, newdata=reguns), 
                 state= substr(rownames(reguns),2,6), 
                 group = substr(rownames(reguns),1,1))


rvals <- select(reguns2, predage, state, group) %>%
  spread(value="predage", key="state")



ggplot(sm3, aes(x=predage))+
  geom_density()+
  facet_grid(group~cm)+
  geom_segment(data=reguns2, aes(x=predage, xend=predage, y=0, yend=0.1, colour=state),alpha=1, size=1.5)


groupmeans <- dplyr::group_by(sm3, group)%>%
  dplyr::summarise(meanpredage = mean(predage))


sm4 <- select(sm3, predage, group, perm, cm) %>%
  left_join(rvals, by="group") %>%
  mutate(mid=(reg+un)/2,          midiff = (reg+un)/2 - predage)  %>%
  left_join(groupmeans, by="group") %>%
  mutate(meandiff = meanpredage-predage)



ggplot(sm4, aes(x=midiff))+
  geom_density()+
  facet_wrap(~cm)

sm4$ma <- substr(sm4$cm,1,2)


ggplot(sm4, aes(y=meandiff, x=ma))+
  geom_boxplot()+
  ylim(-5,5)+
  geom_hline(yintercept = 0)+
#  facet_wrap(~cm)+
  theme_bw()+
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 5, hjust = 1))
    

````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
save(sm3, sm4, file="perms.rdata")

````


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


````